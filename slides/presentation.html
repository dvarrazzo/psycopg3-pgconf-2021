<!DOCTYPE html>
<!--
  Copyright 2010 Google Inc.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

  Original slides: Marcin Wichary (mwichary@google.com)
  Modifications: Ernest Delgado (ernestd@google.com)
                 Alex Russell (slightlyoff@chromium.org)

  landslide modifications: Adam Zapletal (adamzap@gmail.com)
                           Nicolas Perriault (nperriault@gmail.com)
-->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title><em>Psycopg</em>: bridging PostgreSQL and Python</title>
    <!-- Styles -->
    
    <link rel="stylesheet" media="print" href="file:///home/piro/CloudStation/Documents/psycopg/pgconf-2021/slides/theme/css/print.css">
    <link rel="stylesheet" media="screen, projection" href="file:///home/piro/CloudStation/Documents/psycopg/pgconf-2021/slides/theme/css/screen.css">
    
    
    <!-- /Styles -->
    <!-- Javascripts -->
    
    <script type="text/javascript" src="file:///home/piro/CloudStation/Documents/psycopg/pgconf-2021/slides/theme/js/slides.js"></script>
    
    
    
    <!-- /Javascripts -->
</head>
<body>
  <div id="blank"></div>
  <div class="presentation">
    <div id="current_presenter_notes">
      <div id="presenter_note"></div>
    </div>
    <div class="slides">
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-1">
          <div class="inner">
            
            <header><h1><em>Psycopg</em>: bridging PostgreSQL and Python</h1></header>
            
            
            <section><img alt="file:///home/piro/CloudStation/Documents/psycopg/pgconf-2021/slides/img/psycopg.png" src="file:///home/piro/CloudStation/Documents/psycopg/pgconf-2021/slides/img/psycopg.png" />
<p class="text-right">PGConf.Online 2021, <tt class="docutils literal"><span class="pre">'2021-03-01'::date</span></tt></p>
<p class="text-right">Daniele Varrazzo</p>
<!-- Note to piro: you want
:autocmd BufWritePost psycopg.rst :silent !make html --></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              1/18
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-2">
          <div class="inner">
            
            <header><h1>Assumptions</h1></header>
            
            
            <section><ul class="simple">
<li>You know some Python</li>
<li>You know some PostgreSQL</li>
<li>You want to do something with the two</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              2/18
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-3">
          <div class="inner">
            
            <header><h1>Basic usage</h1></header>
            
            
            <section><p>The roles of the main actors</p>
<pre><span></span><span class="kn">import</span> <span class="nn">psycopg2</span>                             <span class="c1"># the driver</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;dbname=piro&quot;</span><span class="p">)</span>      <span class="c1"># the connection/session</span>
<span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>                         <span class="c1"># the cursor - holds a result</span>

<span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select 10 as a, &#39;foo&#39; as b&quot;</span><span class="p">)</span>   <span class="c1"># sends command</span>
<span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>                              <span class="c1"># retrieve results</span>
<span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>                               <span class="c1"># controls the session</span>
</pre>
<p>Different ways to consume data</p>
<pre><span></span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>      <span class="c1"># returns one tuples</span>
<span class="n">cur</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>    <span class="c1"># returns a list of n tuples</span>
<span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>      <span class="c1"># returns a list with all the tuples</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
    <span class="k">pass</span>            <span class="c1"># iterable of tuples</span>
</pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              3/18
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-4">
          <div class="inner">
            
            <header><h1>Returning data</h1></header>
            
            
            <section><pre><span></span><span class="c1"># Normal cursor, returning tuple, separate description</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select 10 as a, &#39;foo&#39; as b&quot;</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="n">cur</span><span class="o">.</span><span class="n">description</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span>
<span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">type_code</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span> <span class="n">display_size</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">internal_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">precision</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">null_ok</span><span class="o">=</span><span class="bp">None</span><span class="p">),</span>
 <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">type_code</span><span class="o">=</span><span class="mi">705</span><span class="p">,</span> <span class="n">display_size</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">internal_size</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">precision</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">null_ok</span><span class="o">=</span><span class="bp">None</span><span class="p">))</span>

<span class="c1"># Other subclasses: a cursor returning a dict</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">psycopg2.extras</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">cursor_factory</span><span class="o">=</span><span class="n">psycopg2</span><span class="o">.</span><span class="n">extras</span><span class="o">.</span><span class="n">RealDictCursor</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select 10 as a, &#39;foo&#39; as b&quot;</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">}</span>

<span class="c1"># ...or a named tuple</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">12</span><span class="p">]:</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">cursor_factory</span><span class="o">=</span><span class="n">psycopg2</span><span class="o">.</span><span class="n">extras</span><span class="o">.</span><span class="n">NamedTupleCursor</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">13</span><span class="p">]:</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select 10 as a, &#39;foo&#39; as b&quot;</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">14</span><span class="p">]:</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">14</span><span class="p">]:</span> <span class="n">Record</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
</pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              4/18
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-5">
          <div class="inner">
            
            <header><h1>Data type mapping</h1></header>
            
            
            <section><p>Default data types mapping: no surprise here</p>
<table border="1" class="data-types docutils">
<colgroup>
<col width="44%" />
<col width="56%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Python</th>
<th class="head">PostgreSQL</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">None</tt></td>
<td><tt class="docutils literal">NULL</tt></td>
</tr>
<tr><td><tt class="docutils literal">bool</tt></td>
<td><tt class="docutils literal">bool</tt></td>
</tr>
<tr><td><tt class="docutils literal">int</tt>,
<tt class="docutils literal">long</tt></td>
<td><tt class="docutils literal">smallint</tt>,
<tt class="docutils literal">integer</tt>,
<tt class="docutils literal">bigint</tt></td>
</tr>
<tr><td><tt class="docutils literal">float</tt></td>
<td><tt class="docutils literal">real</tt>,
<tt class="docutils literal">double</tt></td>
</tr>
<tr><td><tt class="docutils literal">Decimal</tt></td>
<td><tt class="docutils literal">numeric</tt></td>
</tr>
<tr><td><tt class="docutils literal">str</tt>,
<tt class="docutils literal">unicode</tt></td>
<td><tt class="docutils literal">varchar</tt>,
<tt class="docutils literal">text</tt></td>
</tr>
<tr><td><tt class="docutils literal">date</tt></td>
<td><tt class="docutils literal">date</tt></td>
</tr>
<tr><td><tt class="docutils literal">time</tt></td>
<td><tt class="docutils literal">time</tt></td>
</tr>
<tr><td><tt class="docutils literal">datetime</tt></td>
<td><tt class="docutils literal">timestamp</tt>,
<tt class="docutils literal">timestamptz</tt></td>
</tr>
<tr><td><tt class="docutils literal">timedelta</tt></td>
<td><tt class="docutils literal">interval</tt></td>
</tr>
</tbody>
</table></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              5/18
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-6">
          <div class="inner">
            
            <header><h1>More Data!</h1></header>
            
            
            <section><ul>
<li><p class="first"><tt class="docutils literal">list</tt> &lt;-&gt; <tt class="docutils literal">ARRAY</tt></p>
<pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;select array_agg(d)::date[]</span>
<span class="s2">    from generate_series(&#39;2013-07-11&#39;::date, &#39;2013-07-12&#39;::date,</span>
<span class="s2">        &#39;1 day&#39;::interval) s(d)&quot;&quot;&quot;</span><span class="p">)</span>
<span class="c1"># [datetime.date(2013, 7, 11), datetime.date(2013, 7, 12)]</span>
</pre>
</li>
<li><p class="first">[<tt class="docutils literal">named</tt>] <tt class="docutils literal">tuple</tt> &lt;-&gt; composite</p>
<pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE TYPE card AS (value int, suit text)&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">extras</span><span class="o">.</span><span class="n">register_composite</span><span class="p">(</span><span class="s1">&#39;card&#39;</span><span class="p">,</span> <span class="n">cur</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select (8, &#39;hearts&#39;)::card&quot;</span><span class="p">)</span>
<span class="c1"># card(value=8, suit=&#39;hearts&#39;)</span>
</pre>
</li>
<li><p class="first"><tt class="docutils literal">dict</tt> of <tt class="docutils literal">str</tt> &lt;-&gt; <tt class="docutils literal">hstore</tt></p>
<pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">extras</span><span class="o">.</span><span class="n">register_hstore</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select &#39;a =&gt; foo, b =&gt; NULL&#39;::hstore&quot;</span><span class="p">)</span>
<span class="c1"># {&#39;a&#39;: &#39;foo&#39;, &#39;b&#39;: None}</span>
</pre>
</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              6/18
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-7">
          <div class="inner">
            
            <header><h1>Even More Data!</h1></header>
            
            
            <section><ul>
<li><p class="first">Psycopg's <tt class="docutils literal">Range</tt> &lt;-&gt; <tt class="docutils literal">range</tt></p>
<pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select &#39;[0,10)&#39;::int8range&quot;</span><span class="p">)</span>
<span class="c1"># NumericRange(0, 10, &#39;[)&#39;)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">upper_inc</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">lower_inc</span>
<span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
</pre>
<ul class="simple">
<li>Builtin range types supported out-of-the-box</li>
<li>New range type supported by <tt class="docutils literal">psycopg2.extras.register_range()</tt></li>
</ul>
</li>
<li><p class="first">Anythingâ„¢ &lt;-&gt; <tt class="docutils literal">json</tt>, <tt class="docutils literal">jsonb</tt></p>
<pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into mytable (jsondata) values (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="n">Json</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">})])</span>
</pre>
</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              7/18
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-8">
          <div class="inner">
            
            <header><h1>Typecasting</h1></header>
            
            
            <section><img alt="file:///home/piro/CloudStation/Documents/psycopg/pgconf-2021/slides/img/pg-to-py.png" src="file:///home/piro/CloudStation/Documents/psycopg/pgconf-2021/slides/img/pg-to-py.png" />
<p>Typecasters have:</p>
<ul class="simple">
<li>one or more OID</li>
<li>a name</li>
<li>a conversion function</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              8/18
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-9">
          <div class="inner">
            
            <header><h1>Typecasting</h1></header>
            
            
            <section><img alt="file:///home/piro/CloudStation/Documents/psycopg/pgconf-2021/slides/img/pg-to-py.png" src="file:///home/piro/CloudStation/Documents/psycopg/pgconf-2021/slides/img/pg-to-py.png" />
<p>Customizing a typecaster</p>
<pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select 123.45&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="go">(Decimal(&#39;123.45&#39;),)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">psycopg2</span> <span class="kn">import</span> <span class="n">extensions</span> <span class="k">as</span> <span class="n">ext</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">num2float</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">cur</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">ext</span><span class="o">.</span><span class="n">new_type</span><span class="p">((</span><span class="mi">1700</span><span class="p">,),</span> <span class="s2">&quot;NUM2FLOAT&quot;</span><span class="p">,</span> <span class="n">num2float</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ext</span><span class="o">.</span><span class="n">register_type</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">cur</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select 123.45&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="go">(123.45,)</span>
</pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              9/18
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-10">
          <div class="inner">
            
            <header><h1>Typecasting</h1></header>
            
            
            <section><img alt="file:///home/piro/CloudStation/Documents/psycopg/pgconf-2021/slides/img/pg-to-py.png" src="file:///home/piro/CloudStation/Documents/psycopg/pgconf-2021/slides/img/pg-to-py.png" />
<p>Easy array typecaster</p>
<pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select &#39;{1,2,3,4,5}&#39;::numeric[]&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="go">([Decimal(&#39;1&#39;), Decimal(&#39;2&#39;), Decimal(&#39;3&#39;), Decimal(&#39;4&#39;), Decimal(&#39;5&#39;)],)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">ta</span> <span class="o">=</span> <span class="n">ext</span><span class="o">.</span><span class="n">new_array_type</span><span class="p">((</span><span class="mi">1231</span><span class="p">,),</span> <span class="s1">&#39;NUM2FLOAT[]&#39;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ext</span><span class="o">.</span><span class="n">register_type</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="n">cur</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select &#39;{1,2,3,4,5}&#39;::numeric[]&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="go">([1.0, 2.0, 3.0, 4.0, 5.0],)</span>
</pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              10/18
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-11">
          <div class="inner">
            
            <header><h1>Adaptation</h1></header>
            
            
            <section><img alt="file:///home/piro/CloudStation/Documents/psycopg/pgconf-2021/slides/img/py-to-pg.png" src="file:///home/piro/CloudStation/Documents/psycopg/pgconf-2021/slides/img/py-to-pg.png" />
<pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select &#39;</span><span class="si">%s</span><span class="s2">&#39; || &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="go">(&#39;ab&#39;,)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select &#39;</span><span class="si">%s</span><span class="s2">&#39; || &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;O&#39;Reilly&quot;</span><span class="p">,</span> <span class="s1">&#39; Books&#39;</span><span class="p">))</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;ipython-input-29-720a7746fc83&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select &#39;</span><span class="si">%s</span><span class="s2">&#39; || &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;O&#39;Reilly&quot;</span><span class="p">,</span> <span class="s1">&#39; Books&#39;</span><span class="p">))</span>
<span class="gr">ProgrammingError</span>: <span class="n">syntax error at or near &quot;&#39; || &#39;&quot;</span>
<span class="go">LINE 1: select &#39;O&#39;Reilly&#39; || &#39; Books&#39;</span>
<span class="go">                        ^</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select </span><span class="si">%s</span><span class="s2"> || </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;O&#39;Reilly&quot;</span><span class="p">,</span> <span class="s1">&#39; Books&#39;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="go">(&quot;O&#39;Reilly Books&quot;,)</span>
</pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              11/18
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-12">
          <div class="inner">
            
            <header><h1>Adaptation</h1></header>
            
            
            <section><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into students (name) values (&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
</pre>
<img alt="file:///home/piro/CloudStation/Documents/psycopg/pgconf-2021/slides/img/exploits_of_a_mom.png" src="file:///home/piro/CloudStation/Documents/psycopg/pgconf-2021/slides/img/exploits_of_a_mom.png" />
<p>Funny, but wrong conclusion:</p>
<pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into students (name) values (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="p">,</span> <span class="p">[</span><span class="n">name</span><span class="p">])</span>
</pre>
<p>Look ma: no <em>saniti(s|z)ing database input</em> here!</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              12/18
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-13">
          <div class="inner">
            
            <header><h1>CustomiZZing Adaptation</h1></header>
            
            
            <section><img alt="file:///home/piro/CloudStation/Documents/psycopg/pgconf-2021/slides/img/py-to-pg.png" src="file:///home/piro/CloudStation/Documents/psycopg/pgconf-2021/slides/img/py-to-pg.png" />
<ul class="simple">
<li>Based on Python class</li>
<li>Using adapter function</li>
</ul>
<pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Mac</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">:</span>
<span class="gp">... </span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;need 6 args&#39;</span><span class="p">)</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">Mac</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">60</span><span class="p">)</span>
<span class="go">10:20:30:40:50:60</span>
</pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              13/18
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-14">
          <div class="inner">
            
            <header><h1>CustomiXing adaptation</h1></header>
            
            
            <section><img alt="file:///home/piro/CloudStation/Documents/psycopg/pgconf-2021/slides/img/py-to-pg.png" src="file:///home/piro/CloudStation/Documents/psycopg/pgconf-2021/slides/img/py-to-pg.png" />
<ul class="simple">
<li>Based on Python class</li>
<li>Using adapter function</li>
</ul>
<pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">MacAdapter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">getquoted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;::macaddr&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">ext</span><span class="o">.</span><span class="n">register_adapter</span><span class="p">(</span><span class="n">Mac</span><span class="p">,</span> <span class="n">MacAdapter</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">Mac</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">60</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into macs (mac) values (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">m</span><span class="p">])</span>
</pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              14/18
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-15">
          <div class="inner">
            
            <header><h1>The other side too</h1></header>
            
            
            <section><img alt="file:///home/piro/CloudStation/Documents/psycopg/pgconf-2021/slides/img/pg-to-py.png" src="file:///home/piro/CloudStation/Documents/psycopg/pgconf-2021/slides/img/pg-to-py.png" />
<pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">cast_mac</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">cur</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="n">Mac</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">MAC</span> <span class="o">=</span> <span class="n">ext</span><span class="o">.</span><span class="n">new_type</span><span class="p">((</span><span class="mi">829</span><span class="p">,),</span> <span class="s1">&#39;MAC&#39;</span><span class="p">,</span> <span class="n">cast_mac</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ext</span><span class="o">.</span><span class="n">register_type</span><span class="p">(</span><span class="n">MAC</span><span class="p">,</span> <span class="n">cur</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from macs&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
<span class="go">10:20:30:40:50:60</span>
</pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              15/18
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-16">
          <div class="inner">
            
            <header><h1><tt class="docutils literal">pushdemo.py</tt> architecture</h1></header>
            
            
            <section><img alt="file:///home/piro/CloudStation/Documents/psycopg/pgconf-2021/slides/img/pushdemo-diagram.png" src="file:///home/piro/CloudStation/Documents/psycopg/pgconf-2021/slides/img/pushdemo-diagram.png" /></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              16/18
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-17">
          <div class="inner">
            
            <header><h1>Async notification demo</h1></header>
            
            
            <section><p>Using <a class="reference external" href="http://www.gevent.org/">gevent</a>, <a class="reference external" href="http://www.gelens.org/code/gevent-websocket/">gevent-websocket</a>, <a class="reference external" href="https://bitbucket.org/dvarrazzo/psycogreen/">psycogreen</a></p>
<p class="apology">This demo requires the <tt class="docutils literal">pushdemo.py</tt> script running.</p>
<script src="js/jquery.min.js"></script>
<style type="text/css">
      .bar {width: 40px; height: 40px;}
</style>
<script>
/*
    window.onload = function() {
        ws = new WebSocket("ws://localhost:7000/data");
        ws.onopen = function() {
            $('p.apology').hide();
            // drop the offline slide
            $('#target').parents('.slide-wrapper').next().remove();
        }
        ws.onmessage = function(msg) {
            bar = $('#' + msg.data);
            if (bar.length) {
                bar.width(bar.width() + 40);
            } else {
                $('#target').text("DB says: " + msg.data);
            }
        }
    }
    */
</script>
<p id="red" class="bar" style="background-color: red;">&nbsp;</p>
<p id="green" class="bar" style="background-color: green;">&nbsp;</p>
<p id="blue" class="bar" style="background-color: blue;">&nbsp;</p>
<p id="target"></p><p class="text-right">Demo code at <a class="reference external" href="https://github.com/dvarrazzo/psycopg-brighton-2016">https://github.com/dvarrazzo/psycopg-brighton-2016</a></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              17/18
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: psycopg.rst -->
      <div class="slide-wrapper">
        <div class="slide slide-18">
          <div class="inner">
            
            <header><h1>Async notification demo (offline)</h1></header>
            
            
            <section><img alt="file:///home/piro/CloudStation/Documents/psycopg/pgconf-2021/slides/img/pushdemo.png" src="file:///home/piro/CloudStation/Documents/psycopg/pgconf-2021/slides/img/pushdemo.png" /></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="psycopg.rst">psycopg.rst</a>
            </aside>
            
            <aside class="page_number">
              18/18
            </aside>
          </footer>
        </div>
      </div>
      
    </div>
  </div>
  
  <div id="toc" class="sidebar hidden">
    <h2>Table of Contents</h2>
    <table>
      <caption>Table of Contents</caption>
      
      <tr id="toc-row-1">
        <th><a href="#slide1"><em>Psycopg</em>: bridging PostgreSQL and Python</a></th>
        <td><a href="#slide1">1</a></td>
      </tr>
      
      
      <tr id="toc-row-2">
        <th><a href="#slide2">Assumptions</a></th>
        <td><a href="#slide2">2</a></td>
      </tr>
      
      
      <tr id="toc-row-3">
        <th><a href="#slide3">Basic usage</a></th>
        <td><a href="#slide3">3</a></td>
      </tr>
      
      
      <tr id="toc-row-4">
        <th><a href="#slide4">Returning data</a></th>
        <td><a href="#slide4">4</a></td>
      </tr>
      
      
      <tr id="toc-row-5">
        <th><a href="#slide5">Data type mapping</a></th>
        <td><a href="#slide5">5</a></td>
      </tr>
      
      
      <tr id="toc-row-6">
        <th><a href="#slide6">More Data!</a></th>
        <td><a href="#slide6">6</a></td>
      </tr>
      
      
      <tr id="toc-row-7">
        <th><a href="#slide7">Even More Data!</a></th>
        <td><a href="#slide7">7</a></td>
      </tr>
      
      
      <tr id="toc-row-8">
        <th><a href="#slide8">Typecasting</a></th>
        <td><a href="#slide8">8</a></td>
      </tr>
      
      
      <tr id="toc-row-9">
        <th><a href="#slide9">Typecasting</a></th>
        <td><a href="#slide9">9</a></td>
      </tr>
      
      
      <tr id="toc-row-10">
        <th><a href="#slide10">Typecasting</a></th>
        <td><a href="#slide10">10</a></td>
      </tr>
      
      
      <tr id="toc-row-11">
        <th><a href="#slide11">Adaptation</a></th>
        <td><a href="#slide11">11</a></td>
      </tr>
      
      
      <tr id="toc-row-12">
        <th><a href="#slide12">Adaptation</a></th>
        <td><a href="#slide12">12</a></td>
      </tr>
      
      
      <tr id="toc-row-13">
        <th><a href="#slide13">CustomiZZing Adaptation</a></th>
        <td><a href="#slide13">13</a></td>
      </tr>
      
      
      <tr id="toc-row-14">
        <th><a href="#slide14">CustomiXing adaptation</a></th>
        <td><a href="#slide14">14</a></td>
      </tr>
      
      
      <tr id="toc-row-15">
        <th><a href="#slide15">The other side too</a></th>
        <td><a href="#slide15">15</a></td>
      </tr>
      
      
      <tr id="toc-row-16">
        <th><a href="#slide16"><tt class="docutils literal">pushdemo.py</tt> architecture</a></th>
        <td><a href="#slide16">16</a></td>
      </tr>
      
      
      <tr id="toc-row-17">
        <th><a href="#slide17">Async notification demo</a></th>
        <td><a href="#slide17">17</a></td>
      </tr>
      
      
      <tr id="toc-row-18">
        <th><a href="#slide18">Async notification demo (offline)</a></th>
        <td><a href="#slide18">18</a></td>
      </tr>
      
      
    </table>
  </div>
  
  <div id="help" class="sidebar hidden">
    <h2>Help</h2>
    <table>
      <caption>Help</caption>
      <tr>
        <th>Table of Contents</th>
        <td>t</td>
      </tr>
      <tr>
        <th>ExposÃ©</th>
        <td>ESC</td>
      </tr>
      <tr>
        <th>Full screen slides</th>
        <td>e</td>
      </tr>
      <tr>
        <th>Presenter View</th>
        <td>p</td>
      </tr>
      <tr>
        <th>Source Files</th>
        <td>s</td>
      </tr>
      <tr>
        <th>Slide Numbers</th>
        <td>n</td>
      </tr>
      <tr>
        <th>Toggle screen blanking</th>
        <td>b</td>
      </tr>
      <tr>
        <th>Show/hide slide context</th>
        <td>c</td>
      </tr>
      <tr>
        <th>Notes</th>
        <td>2</td>
      </tr>
      <tr>
        <th>Help</th>
        <td>h</td>
      </tr>
    </table>
  </div>
  <script>main()</script>
</body>
</html>